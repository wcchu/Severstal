---
title: "exploration"
output: html_document
---

```{r setup, include=FALSE}
library(reticulate)
use_python("/usr/local/bin/python3.7")
```

```{python}
import tensorflow as tf
import glob
import random
import numpy as np
import pandas as pd
import csv
import time
import matplotlib.pyplot as plt
import matplotlib.image as mpimg
```

# Preprocess masks

## marker-to-mask converter

```{python}
def make_mask(marker_string, nv, nh):
    # initial mask is empty 1D array
    mask = np.zeros(nv * nh)

    # if markers exist, add detect part according to markers
    if len(marker_string) > 0:
        markers = np.array(marker_string.split(' ')).reshape(-1, 2)
        for marker in markers:
            start = int(marker[0])
            length = int(marker[1])
            mask[start: start+length] = 1.0

    mask = np.reshape(mask, (nv, nh))

    return mask
```

## extract the first N image IDs and their masks

```{python}
N = 1000
train_mask_file = "data/train.csv"

with open(train_mask_file, "r") as f:
    reader = csv.reader(f)
    header = next(reader)
    print("CSV header: {}".format(header))

    masks = dict()
    for i, row in enumerate(reader):
        if i < N:
            # read image id and defect type
            img_id, defect_type = row[0].split('.jpg_')

            # process mask
            mask_marker_string = row[1]
            mask = make_mask(mask_marker_string, 256, 1600)

            if img_id in masks:
                masks[img_id][defect_type] = mask
            else:
                masks[img_id] = dict({defect_type: mask})
```

```{python}
random.seed(2)
img_id_0 = random.choice(list(masks.keys()))
print(img_id_0)
print(masks[img_id_0])
```

# Preprocess training images

```{python}
train_img_dir = 'data/train_images/'
train_img_suffix = '.jpg'

def get_image(img_id):
    image_path = train_img_dir + img_id + train_img_suffix
    print(image_path)
    # import image
    image = mpimg.imread(image_path)
    # pick just one channel and normalize
    image = tf.cast(image[:, :, 0], tf.float32)/255.0
    return image

image_0 = get_image(img_id_0)

plt.imshow(image_0)

for m in [1, 2, 3, 4]:
    plt.subplot(4, 1, m).imshow(masks[img_id_0][str(m)])
```


